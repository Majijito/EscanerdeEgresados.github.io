<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>| Escáner de Egresados | Bolsa de Empleo | </title>

  <style>
    body, html {
      margin: 0; padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    .login-overlay {
      position: fixed;
      top:0; left:0; width:100%; height:100%;
      background: #f0f2f5;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .login-box {
      background: white;
      padding: 30px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      text-align: center;
    }
    .login-box img {
      max-width: 180px;
      margin-bottom: 20px;
    }
    .login-box input[type="email"],
    .login-box input[type="password"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .login-box button {
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      background: #5257f8;
      border: none;
      color: white;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .login-box button:hover {
      background: #4148c1;
    }
    .login-box .link {
      margin-top: 12px;
      font-size: 14px;
    }
    .login-box .link a {
      color: #5257f8;
      text-decoration: none;
      cursor: pointer;
    }
    .login-box .link a:hover {
      text-decoration: underline;
    }
    .hidden {
      display: none;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f0f2f5; color: #333; }
    .container { width: 95%; max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { text-align: center; margin-bottom: 30px; }
    .row { display: flex; gap: 20px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 280px; }
    .file-drop-area { border: 2px dashed #ccc; padding: 30px; border-radius: 8px; text-align: center; background: #fff; position: relative; }
    .file-drop-area input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .file-drop-area .msg { font-size: 16px; color: #555; }
    .file-list { margin-top: 10px; text-align: left; font-size: 14px; color: #333; }
    .file-list div { background: #eef; padding: 4px 8px; border-radius: 5px; margin: 3px 0; }
    .buttons-row { text-align: center; margin: 20px 0; }
    .buttons-row button { color: white; border: none; padding: 12px 24px; margin: 0 10px; border-radius: 5px; font-size: 16px; cursor: pointer; }
    #procesarBtn { background-color: #5257f8; } #procesarBtn:hover { background-color: #5257f8; }
    #limpiarBtn  { background-color: #6c757d; } #limpiarBtn:hover  { background-color: #5a6268; }
    #exportarBtn { background-color: #28a745; } #exportarBtn:hover { background-color: #218838; }
    #exportarFil {background-color: #28a745; } #exportarFil:hover { background-color: #218838; }
    #estado { text-align: center; margin-top: 10px; font-weight: bold; }
    .section-table { margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background: #5257f8; color: white; }
    tr:nth-child(even){ background-color: #f9f9f9; }
    .charts-row { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px; }
    .chart-container { flex: 1; min-width: 300px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body> 
    <!-- Overlay de login -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box" id="loginBox">
      <img src="https://media2.utp.edu.co/oficinas/60/Bolsa-de-empleo-azul.png" alt="Logo Bolsa de Empleo UTP" />
      <h2>Iniciar Sesión</h2>
      <input type="email" id="loginEmail" placeholder="Correo" value="bolsadeempleoutp@utp.edu.co" readonly />
      <input type="password" id="loginPassword" placeholder="Contraseña" />
      <button id="btnLogin">Entrar</button>
      <div class="link">
        <a id="linkForgot">Olvidé mi contraseña</a>
      </div>
      <div class="link">
        <a id="linkChange">Cambiar contraseña</a>
      </div>
    </div>
    <!-- Formulario cambio de contraseña (oculto inicialmente) -->
    <div class="login-box hidden" id="changeBox">
      <img src="https://media2.utp.edu.co/oficinas/60/Bolsa-de-empleo-azul.png" alt="Logo Bolsa de Empleo UTP" />
      <h2>Cambiar Contraseña</h2>
      <input type="password" id="oldPassword" placeholder="Contraseña actual" />
      <input type="password" id="newPassword" placeholder="Nueva contraseña" />
      <input type="password" id="confirmPassword" placeholder="Confirmar nueva contraseña" />
      <button id="btnChange">Actualizar contraseña</button>
      <div class="link">
        <a id="linkBackToLogin1">Volver al login</a>
      </div>
    </div>
    <!-- Formulario recuperación (oculto inicialmente) -->
    <div class="login-box hidden" id="forgotBox">
      <img src="https://media2.utp.edu.co/oficinas/60/Bolsa-de-empleo-azul.png" alt="Logo Bolsa de Empleo UTP" />
      <h2>Recuperar contraseña</h2>
      <p>Se enviará un enlace al correo <strong>bolsadeempleoutp@utp.edu.co</strong></p>
      <button id="btnRecover">Enviar enlace</button>
      <div class="link">
        <a id="linkBackToLogin2">Volver al login</a>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="container" id="appContent" style="display: none;">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap;">
      <img src="https://media2.utp.edu.co/oficinas/60/Bolsa-de-empleo-azul.png" alt="Logo Bolsa de Empleo UTP" style="height: 50px;">
      <h1 style="flex: 1; text-align: center; margin: 0;">Escáner de Egresados | Bolsa de Empleo</h1>
      <button id="btnLogout" style="
        padding: 8px 16px;
        background-color: #5257f8;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        height: 40px;
      ">Cerrar sesión</button>
    </div>

    <div class="row">
      <div class="col">
        <div class="file-drop-area" id="dropMaestro">
          <div class="msg">Seleccione o arrastre el archivo maestro</div>
          <input type="file" id="fileMaestro" accept=".xlsx" />
          <div class="file-list" id="listMaestro"></div>
        </div>
      </div>
      <div class="col">
        <div class="file-drop-area" id="dropEsclavos">
          <div class="msg">Seleccione o arrastre los archivos esclavos</div>
          <input type="file" id="fileEsclavos" accept=".xlsx" multiple />
          <div class="file-list" id="listEsclavos"></div>
        </div>
      </div>
    </div>

    <div class="buttons-row">
      <button id="procesarBtn">Procesar</button>
      <button id="limpiarBtn">Limpiar</button>
      <button id="exportarBtn">Exportar Excel</button>
      <button id="exportarFil">Exportar Filtrados</button>

    </div>

    <div id="estado"></div>

    <!-- FILTROS -->
    <div class="section-table" style="margin-top: 20px;">
      <div class="filtros" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start;">
        <div style="flex: 1;">
          <label for="filtroPrograma">Filtrar por Programa:</label><br>
          <select id="filtroPrograma" style="width: 100%; padding: 8px;">
            <option value="">Todos los programas</option>
          </select>

          <!-- NUEVO: Última Vacante debajo de Programa (izquierda) -->
          <div id="vacantesFilters" style="display:none; margin-top: 12px;">
            <label for="filtroUltimaVacante">Última Vacante:</label><br>
            <select id="filtroUltimaVacante" style="width: 100%; padding: 8px;">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <div style="flex: 1;">
          <label for="filtroGenero">Filtrar por Género:</label><br>
          <select id="filtroGenero" style="width: 100%; padding: 8px;">
          <option value="">Todos los géneros</option>
          </select>
        </div>


        <div style="flex: 1;">
          <label for="filtroNivel">Filtrar por Nivel educativo:</label><br>
          <select id="filtroNivel" style="width: 100%; padding: 8px;">
            <option value="">Todos los niveles</option>
          </select>
        </div>

        <div style="flex: 1;">
          <label for="filtroTexto">Buscar:</label><br>
          <input type="text" id="filtroTexto" placeholder="Nombre, documento.." style="width: 100%; padding: 8px;" />
        </div>

        <div style="display: flex; flex-direction: row; gap: 10px; align-items: center; margin-top: 25px;">
          <button id="btnAplicarFiltro" style="background-color: #5257f8; color: white; border: none; padding: 10px 16px; border-radius: 5px; font-weight: bold; display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <span style="font-size: 18px;"></span> Aplicar filtros
          </button>
          <button id="btnLimpiarFiltro" style="background: none; border: none; color: brown; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;">
            <span style="font-size: 18px;"></span> Limpiar filtros
          </button>
        </div>
      </div>
    </div>
<!-- NUEVO: Contador total mostrado -->
<div class="section-table" style="margin: 8px 0; display:flex; justify-content:flex-end;">
  <span id="contadorPersonas"
        style="background:#5257f8; color:#fff; padding:6px 12px; border-radius:10px; font-weight:bold;">
    Total: 0
  </span>
</div>

    <div class="section-table" id="tablaResultados"></div>

    <div class="charts-row">
      <div class="chart-container">
        <h3>Postulados vs Colocados</h3>
        <canvas id="chartBusquedaColocacion"></canvas>
      </div>
      <div class="chart-container">
        <h3>Tasa de Búsqueda de Empleo</h3>
        <canvas id="chartTasas"></canvas>
      </div>
      <div class="chart-container">
        <h3>Clasificación de Hojas de Vida(%)</h3>
        <canvas id="chartHojaVida"></canvas>
      </div>
      <div class="chart-container">
        <h3>Conteo por Programa utp</h3>
        <canvas id="chartProgramaCount"></canvas>
        <div id="leyendaProgramas" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // Contraseña demo
  let storedPassword = "admin123";  

  const loginOverlay = document.getElementById("loginOverlay");
  const appContent = document.getElementById("appContent");

  const loginBox = document.getElementById("loginBox");
  const changeBox = document.getElementById("changeBox");
  const forgotBox = document.getElementById("forgotBox");

  const btnLogin = document.getElementById("btnLogin");
  const linkForgot = document.getElementById("linkForgot");
  const linkChange = document.getElementById("linkChange");
  const linkBackToLogin1 = document.getElementById("linkBackToLogin1");
  const linkBackToLogin2 = document.getElementById("linkBackToLogin2");

  const btnChange = document.getElementById("btnChange");
  const btnRecover = document.getElementById("btnRecover");

  function onLoginSuccess() {
    loginOverlay.style.display = "none";
    appContent.style.display = "block";
  }

  btnLogin.addEventListener("click", () => {
    const pwd = document.getElementById("loginPassword").value;
    if (pwd === storedPassword) {
      onLoginSuccess();
    } else {
      alert("Contraseña incorrecta");
    }
  });

  linkForgot.addEventListener("click", () => {
    loginBox.classList.add("hidden");
    forgotBox.classList.remove("hidden");
  });
  linkChange.addEventListener("click", () => {
    loginBox.classList.add("hidden");
    changeBox.classList.remove("hidden");
  });
  linkBackToLogin1.addEventListener("click", () => {
    changeBox.classList.add("hidden");
    loginBox.classList.remove("hidden");
  });
  linkBackToLogin2.addEventListener("click", () => {
    forgotBox.classList.add("hidden");
    loginBox.classList.remove("hidden");
  });

  btnChange.addEventListener("click", () => {
    const oldPwd = document.getElementById("oldPassword").value;
    const newPwd = document.getElementById("newPassword").value;
    const confirmPwd = document.getElementById("confirmPassword").value;

    if (oldPwd !== storedPassword) {
      alert("La contraseña actual no coincide");
      return;
    }
    if (!newPwd) {
      alert("Ingrese una nueva contraseña válida");
      return;
    }
    if (newPwd !== confirmPwd) {
      alert("La confirmación no coincide");
      return;
    }
    storedPassword = newPwd;
    alert("Contraseña actualizada correctamente. Por favor inicia sesión con la nueva contraseña.");
    changeBox.classList.add("hidden");
    loginBox.classList.remove("hidden");
  });

  btnRecover.addEventListener("click", () => {
    alert("Tu contraseña actual es: " + storedPassword);
    forgotBox.classList.add("hidden");
    loginBox.classList.remove("hidden");
  });

  window.addEventListener("load", () => {
    loginOverlay.style.display = "flex";
    appContent.style.display = "none";
  });
</script>

<script>
  let chart1=null, chart2=null; let chartHv = null; let chartProg = null;
  let coincidenciasExportables=[];
  let selectedEsclavoFiles = [];
  let hasVacantesMeta = false; // si hay archivo de oferentes/postulados

  // ===== Base =====
  const norm = s => (s==null?'':String(s))
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\u00A0/g,' ')
    .replace(/[.\-_/]+/g,' ')
    .replace(/\s+/g,' ')
    .trim().toLowerCase();

  const onlyDigits = x => String(x??'').replace(/[^\d]/g,'');

  // ===== Encabezados + lectura robusta =====
  const HDR = {
    id: [
      'numero documento','número documento','numero de documento','número de documento',
      'documento','documento de identidad','documento identidad',
      'num documento','nro documento','no documento','no. documento','no de documento',
      'no doc','no. doc','num doc','numero doc','número doc','nro doc',
      'identificacion','identificación','numero de identificacion','número de identificación',
      'cedula','cédula','cc','id','doc'
    ],
    nombres: ['nombres','nombre','primer nombre'],
    apellidos:['apellidos','apellido','primer apellido','segundo apellido'],
    nombreCompleto:['nombre completo','nombres y apellidos','nombres apellidos','nombre y apellido'],
    programa:['nombre programa','programa','titulo obtenido','título obtenido','titulo','título','programa academico','programa académico','carrera'],
    nivel:['nivel','nivel de estudio','nivel educativo','nivel academico','nivel académico','ultimo nivel educativo','último nivel educativo'],
    genero:['genero','género','sexo','identifica genero','identifica género'],
    hv:['% hoja vida','% hoja de vida','porcentaje hoja de vida','hoja de vida %','hv','% hv','%hv','porcentaje hv'],
    telefono:['telefono','teléfono','celular','nro celular','numero celular','número celular','contacto','movil','móvil'],
    correo:['correo','email','e-mail','mail','correo electronico','correo electrónico']
  };

  const VAC_HDR = {
    codigo: ['codigo vacante','código vacante','cod vacante','vacante codigo','codigo','código'],
    ultima: ['ultima vacante','última vacante','vacante ultima','vacante última']
  };

  const isHeaderLike = v => {
    const s = norm(v);
    return s && (
      HDR.id.includes(s) || HDR.nombres.includes(s) || HDR.apellidos.includes(s) ||
      HDR.nombreCompleto.includes(s) || HDR.programa.includes(s) ||
      HDR.nivel.includes(s) || HDR.genero.includes(s) || HDR.hv.includes(s) ||
      HDR.telefono.includes(s) || HDR.correo.includes(s)
    );
  };
  function findHeaderRowIndex(arr) {
    let bestIdx = -1, bestScore = -1;
    const limit = Math.min(arr.length, 50);
    for (let i=0; i<limit; i++){
      const row = arr[i] || [];
      let score = 0;
      for (const cell of row){
        const n = norm(cell);
        if (!n) continue;
        if (isHeaderLike(cell)) score += 2;
        else if (n.length <= 30 && !/^\d+$/.test(n)) score += 1;
      }
      if (row.filter(x => String(x||'').trim()!=='').length >= 3 && score > bestScore){
        bestScore = score; bestIdx = i;
      }
    }
    return bestIdx;
  }
  async function readWorkbookSmart(file){
    const reader = new FileReader();
    const load = new Promise((resolve, reject) => {
      reader.onload = e => {
        try{
          const wb = XLSX.read(e.target.result, { type:'binary' });
          let rows = [];
          wb.SheetNames.forEach(name => {
            const ws = wb.Sheets[name];
            const arr = XLSX.utils.sheet_to_json(ws, { header:1, defval:'', raw:false });
            if (!arr || !arr.length) return;

            let hdrIdx = findHeaderRowIndex(arr);
            if (hdrIdx >= 0) {
              const headers = (arr[hdrIdx]||[]).map(h => h || '');
              for (let r = hdrIdx+1; r < arr.length; r++){
                const row = arr[r] || [];
                if (row.every(v => (v==null || String(v).trim()===''))) continue;
                const obj = {};
                for (let c=0; c<headers.length; c++){
                  obj[headers[c] || `__col_${c}`] = row[c];
                }
                rows.push(obj);
              }
            } else {
              const maxCols = Math.max(...arr.map(r => r.length));
              for (let r=0; r<arr.length; r++){
                const row = arr[r] || [];
                if (row.every(v => (v==null || String(v).trim()===''))) continue;
                const obj = {};
                for (let c=0; c<maxCols; c++){
                  obj[`col_${c}`] = row[c];
                }
                rows.push(obj);
              }
            }
          });
          resolve(rows);
        }catch(err){ reject(err); }
      };
      reader.onerror = reject;
    });
    reader.readAsBinaryString(file);
    return load;
  }
  function chooseIdByContent(rows){
    if (!rows.length) return null;
    const keys = Object.keys(rows[0]);
    const scores = keys.map(k => {
      let cnt=0;
      for (let i=0;i<Math.min(rows.length,400);i++){
        const v = rows[i]?.[k];
        const s = String(v||'').trim();
        const d = onlyDigits(s);
        if (d.length>=6 && d.length<=15){
          const ratio = d.length / (s.replace(/\s+/g,'').length || 1);
          if (ratio >= 0.9) cnt++;
        }
      }
      return {k, cnt};
    }).sort((a,b)=>b.cnt-a.cnt);
    return (scores[0]?.cnt || 0) >= 5 ? scores[0].k : null;
  }
  function pick(row, list) {
    for (const k of Object.keys(row)){
      if (list.includes(norm(k))) return row[k];
    }
    return undefined;
  }
  function toCanonical(row, idFallbackKey=null){
    let rawId = row['NUMERO_DOCUMENTO'] ?? row['Número Documento'];
    if (!rawId) {
      for (const k of Object.keys(row)){
        if (HDR.id.includes(norm(k))) { rawId = row[k]; break; }
      }
    }
    if (!rawId && idFallbackKey) rawId = row[idFallbackKey];
    if (!rawId) {
      let best=''; let bestLen=0;
      for (const v of Object.values(row)){
        const d = onlyDigits(v);
        if (d.length>=6 && d.length<=15 && d.length>bestLen){ best=d; bestLen=d.length; }
      }
      rawId = best;
    }
    const id = onlyDigits(rawId);
    if (!id) return null;

    const nomComp = row['NOMBRE_COMPLETO'] ?? row['Nombre Completo'] ?? pick(row, HDR.nombreCompleto);
    const nombres = row['Nombres'] ?? pick(row, HDR.nombres);
    const apels   = row['Apellidos'] ?? pick(row, HDR.apellidos);
    const nombre  = (nomComp && String(nomComp).trim()) || [nombres, apels].filter(Boolean).join(' ').trim() || '';

    const programa = row['NOMBRE_PROGRAMA'] ?? row['Nombre Programa'] ?? pick(row, HDR.programa) ?? '';
    const nivel    = row['NIVEL'] ?? row['Nivel'] ?? row['Nivel de Estudio'] ?? pick(row, HDR.nivel) ?? '';
    const genero   = row['GENERO'] ?? row['Género'] ?? row['Genero'] ?? pick(row, HDR.genero) ?? '';
    const hojaVida = row['% Hoja Vida'] ?? row['% Hoja de Vida'] ?? pick(row, HDR.hv) ?? '';
    const telefono = row['CELULAR'] ?? row['Teléfono'] ?? pick(row, HDR.telefono) ?? '';
    const correo   = row['Correo']  ?? row['EMAIL']   ?? pick(row, HDR.correo)   ?? '';

    // campos de vacantes
    let codigoVacante, ultimaVacante;
    for (const k of Object.keys(row)){
      const nk = norm(k);
      if (VAC_HDR.codigo.includes(nk) && codigoVacante === undefined) codigoVacante = row[k];
      if (VAC_HDR.ultima.includes(nk) && ultimaVacante === undefined) ultimaVacante = row[k];
    }

    return { id, nombre, programa, nivel, genero, hojaVida, telefono, correo, codigoVacante, ultimaVacante };
  }

  // ===== Normalización de Programas =====
  const STOP = new Set(['de','del','la','el','los','las','y','en','con','por','para','a','e','linea','énfasis','enfasis','con','sin','por']);
  const ACCENT_WORDS = {
    administracion:'Administración', auditoria:'Auditoría', computacion:'Computación',
    contabilidad:'Contabilidad', educacion:'Educación', electrica:'Eléctrica', electrico:'Eléctrico',
    fisica:'Física', industrial:'Industrial', ingenieria:'Ingeniería', logistica:'Logística',
    mecanica:'Mecánica', mecatronica:'Mecatrónica', quimica:'Química', sistemas:'Sistemas',
    tecnologia:'Tecnología', gerencia:'Gerencia', ambiental:'Ambiental', datos:'Datos',
    analitica:'Analítica', construcciones:'Construcciones', proyectos:'Proyectos',
    musical:'Musical', veterinaria:'Veterinaria', zootecnia:'Zootecnia', ingles:'Inglés',
    informatica:'Informática', primaria:'Primaria', matematicas:'Matemáticas'
  };

  function fixTypos(s){
    s = s.replace(/\(.*?\)|\[.*?\]/g,' ');
    s = s.replace(/\binenier[oa]?\b/g,'ingenieria');
    s = s.replace(/\bing[ei]nier[oa]\b/g,'ingenieria');
    s = s.replace(/\bing[ei]nieria?\b/g,'ingenieria');
    s = s.replace(/\bingenier[io]\b/g,'ingenieria');
    s = s.replace(/\bmecatronico?s?\b/g,'mecatronica');
    s = s.replace(/\bmecatronika?\b/g,'mecatronica');
    s = s.replace(/\bmecanico?s?\b/g,'mecanica');
    s = s.replace(/\belectrist[ao]s?\b/g,'electrica');
    s = s.replace(/\belectrico?s?\b/g,'electrica');
    s = s.replace(/\bquimico?s?\b/g,'quimica');
    s = s.replace(/\bmagister\b/g,'maestria');
    s = s.replace(/\bespecialista\b/g,'especializacion');
    s = s.replace(/\btecnic[oa]s?\b/g,'tecnologia');
    s = s.replace(/\btecnolog[oa]s?\b/g,'tecnologia');
    s = s.replace(/\blicenciad[oa]s?\b/g,'licenciatura');
    s = s.replace(/\bdoctor(a|ado)\b/g,'doctorado');
    s = s.replace(/\bnocturn[oa]\b/g,'');
    return s;
  }

  function canonProgram(raw){
    if (!raw) return '';
    let s = norm(raw);
    s = fixTypos(s);

    s = s
      .replace(/\bing\.\b/g,'ingenieria')
      .replace(/\btecnolog(?:ia|ias)\b/g,'tecnologia')
      .replace(/\bmaestr[ií]a\b/g,'maestria')
      .replace(/\bespecializacion\b/g,'especializacion')
      .replace(/\blicenciatura\b/g,'licenciatura')
      .replace(/\s+/g,' ')
      .trim();

    let nivel = '';
    if (/\bingenier/.test(s)) nivel = 'ingenieria';
    else if (/\btecnologia\b/.test(s)) nivel = 'tecnologia';
    else if (/\blicenciatura\b/.test(s)) nivel = 'licenciatura';
    else if (/\bmaestria\b/.test(s)) nivel = 'maestria';
    else if (/\bespecializacion\b/.test(s)) nivel = 'especializacion';
    else if (/\bdoctorado\b/.test(s)) nivel = 'doctorado';

    let area = '';
    if (/mecatron/.test(s)) area = 'mecatronica';
    else if (/mecan/.test(s)) area = 'mecanica';
    else if (/electr/.test(s)) area = 'electrica';
    else if (/industrial/.test(s)) area = 'industrial';
    else if (/(sistemas|computac)/.test(s)) area = 'sistemas_y_computacion';
    else if (/fisic/.test(s)) area = 'fisica';
    else if (/quimic/.test(s)) area = 'quimica';
    else if (/ambient/.test(s)) area = 'ambiental';
    else if (/turismo/.test(s)) area = 'turismo';
    else if (/gerencia/.test(s)) area = 'gerencia';
    else if (/construccion/.test(s)) area = 'construcciones';
    else if (/proyecto/.test(s)) area = 'proyectos';
    else if (/veterinari/.test(s) || /zootecn/.test(s)) area = 'medicina_veterinaria_y_zootecnia';
    else if (/auditor/.test(s)) area = 'auditoria';
    else if (/administracion/.test(s)) area = 'administracion';
    else if (/contabilidad/.test(s)) area = 'contabilidad';

    if (nivel && area) return `${nivel}_${area}`;
    if (nivel) return `${nivel}_${s.replace(/\s+/g,'_')}`;
    return s.replace(/\s+/g,'_');
  }

  function prettyWord(w){
    const base = ACCENT_WORDS[w] || w;
    return STOP.has(base) ? base : base.charAt(0).toUpperCase()+base.slice(1);
  }

  function prettyProgram(canon, raw){
    if (!canon) return (raw||'').trim();
    const map = {
      'ingenieria_mecatronica':'Ingeniería Mecatrónica',
      'ingenieria_mecanica':'Ingeniería Mecánica',
      'ingenieria_electrica':'Ingeniería Eléctrica',
      'ingenieria_industrial':'Ingeniería Industrial',
      'ingenieria_sistemas_y_computacion':'Ingeniería de Sistemas y Computación',
      'ingenieria_fisica':'Ingeniería Física',
      'ingenieria_quimica':'Ingeniería Química',
      'ingenieria_ambiental':'Ingeniería Ambiental',
      'tecnologia_industrial':'Tecnología Industrial',
      'tecnologia_mecanica':'Tecnología Mecánica',
      'tecnologia_electrica':'Tecnología Eléctrica',
      'tecnologia_mecatronica':'Tecnología Mecatrónica',
      'licenciatura_en_ingles':'Licenciatura en Inglés'
    };
    if (map[canon]) return map[canon];

    const words = canon.split('_').map(prettyWord);
    const txt = words.join(' ');
    if (txt.length < 3) {
      const nice = (raw||'').toLowerCase().replace(/\b\w/g,m=>m.toUpperCase());
      return nice;
    }
    return txt.replace(/\bY\b/,'y').replace(/\bDe\b/,'de').replace(/\bEn\b/,'en');
  }

  // --------- Niveles educativos ----------
  function canonNivel(raw){
    const s = norm(raw);
    if(!s) return '';
    if (/\btecnic[oa]\b/.test(s) || /\btecnolog(?:o|a|ico|icos|ica|icas)\b/.test(s)) return 'tecnologia';
    if (/\b(bachiller|secundaria|media)\b/.test(s)) return 'bachiller';
    if (/\blicenciatura\b/.test(s)) return 'licenciatura';
    if (/\b(pregrado|universitari[oa]|profesional)\b/.test(s)) return 'profesional';
    if (/\bespecial(i|í)zaci(?:on|ón)|especialista\b/.test(s)) return 'especializacion';
    if (/\b(maestr(i|í)a|magister|magíster)\b/.test(s)) return 'maestria';
    if (/\b(doctorado|ph\.?d)\b/.test(s)) return 'doctorado';
    return s;
  }
  function prettyNivel(c){
    const map = {
      bachiller: 'Bachiller',
      tecnologia: 'Tecnología',
      profesional: 'Profesional',
      licenciatura: 'Licenciatura',
      especializacion: 'Especialización',
      maestria: 'Maestría',
      doctorado: 'Doctorado'
    };
    return map[c] || (c ? c.charAt(0).toUpperCase()+c.slice(1) : '');
  }

  function isProgramaTecnologia(programaRaw){
    const s = norm(programaRaw || '');
    if (!s) return false;
    if (/tecnolog/.test(s)) return true;
    const cp = canonProgram(programaRaw || '');
    return cp.includes('tecnologia');
  }
  function isProgramaProfesional(programaRaw){
    const s = norm(programaRaw || '');
    if (!s) return false;
    if (/ingenier/.test(s) || /licenciatur/.test(s)) return true;
    const cp = canonProgram(programaRaw || '');
    return /^ingenieria_/.test(cp) || /^licenciatura/.test(cp);
  }
  function nivelCanonRobusto(nivelRaw, programaRaw){
    const n = canonNivel(nivelRaw || '');
    if (isProgramaTecnologia(programaRaw)) return 'tecnologia';
    if (isProgramaProfesional(programaRaw)) {
      if (n === 'maestria' || n === 'especializacion' || n === 'doctorado') return n;
      return 'profesional';
    }
    return n;
  }

  // ===== Drag&Drop =====
  function setupDropArea(dropArea, input) {
    dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('dragover'); });
    dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
    dropArea.addEventListener('drop', e => {
      e.preventDefault(); dropArea.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) { input.files = e.dataTransfer.files; input.dispatchEvent(new Event('change')); }
    });
  }
  function showNames(inputElem, listElem) {
    const files = [...inputElem.files]; listElem.innerHTML='';
    files.forEach(f=>{ const div=document.createElement('div'); div.textContent=f.name; listElem.appendChild(div); });
  }

  function showNamesFromArray(listElem, filesArr){
    listElem.innerHTML='';
    filesArr.forEach(f=>{ const div=document.createElement('div'); div.textContent=f.name; listElem.appendChild(div); });
  }
  function mergeEsclavoFiles(targetArr, newFileList){
    const isSame=(a,b)=> a.name===b.name && a.size===b.size && a.lastModified===b.lastModified;
    const incoming=[...newFileList];
    for(const f of incoming){
      if(!targetArr.some(x=>isSame(x,f))){
        targetArr.push(f);
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const dropM=document.getElementById('dropMaestro'), inpM=document.getElementById('fileMaestro'), listM=document.getElementById('listMaestro');
    setupDropArea(dropM, inpM); inpM.addEventListener('change', ()=>showNames(inpM, listM));

    const dropE=document.getElementById('dropEsclavos'), inpE=document.getElementById('fileEsclavos'), listE=document.getElementById('listEsclavos');
    setupDropArea(dropE, inpE);
    inpE.addEventListener('change', ()=>{
      if (inpE.files && inpE.files.length){
        mergeEsclavoFiles(selectedEsclavoFiles, inpE.files);
        showNamesFromArray(listE, selectedEsclavoFiles);
        inpE.value='';
      }
    });
  });

  // ===== Tabla / Filtros =====
function renderTabla(list){
  const el = document.getElementById('tablaResultados');
  const ultimaSel = (document.getElementById('filtroUltimaVacante')?.value || '');
  const showVacCols = !!ultimaSel; // solo mostrar columnas de vacantes si hay filtro aplicado

  let html = `<table><thead><tr>
    <th>Número Documento</th><th>Nombre</th><th>Programa UTP</th><th>Último nivel educativo</th><th>Género</th>
    <th>Celular</th><th>Correo</th><th>Hoja de Vida
    </th>${showVacCols ? '<th>Última Vacante</th><th>Código Vacante</th>' : ''}
  </tr></thead><tbody>`;

  list.forEach(r=>{
    const nivelBonito = prettyNivel(nivelCanonRobusto(r.nivel || '', r.programa || ''));
    html += `<tr>
  <td>${r.id}</td><td>${r.nombre || '—'}</td><td>${r.programa || '—'}</td>
  <td>${nivelBonito || '—'}</td><td>${r.genero || '—'}</td>
  <td>${r.telefono || '—'}</td><td>${r.correo || '—'}</td><td>${r.hojaVida || '—'}</td>
  ${showVacCols ? `<td>${r.ultimaVacante ?? '—'}</td><td>${r.codigoVacante ?? '—'}</td>` : ''}
</tr>`;
  });

  html += `</tbody></table>`;
  // NUEVO: actualizar contador
const cnt = document.getElementById('contadorPersonas');
if (cnt) cnt.textContent = `Total: ${list.length.toLocaleString('es-CO')}`;
  el.innerHTML = html;
}

  function fillProgramFilter(list){
    const sel = document.getElementById('filtroPrograma');
    const map = new Map(); // canon -> label
    list.forEach(x=>{
      const canon = canonProgram(x.programa || '');
      const label = prettyProgram(canon, x.programa || '');
      if (canon && !map.has(canon)) map.set(canon, label);
    });
    const items = [...map.entries()].sort((a,b)=> a[1].localeCompare(b[1],'es'));
    sel.innerHTML = '<option value="">Todos los programas</option>';
    for (const [canon,label] of items){
      const opt = document.createElement('option'); opt.value = canon; opt.textContent = label; sel.appendChild(opt);
    }
  }

  function fillNivelFilter(list){
    const sel = document.getElementById('filtroNivel');
    const set = new Map();
    list.forEach(x=>{
      const c = nivelCanonRobusto(x.nivel || '', x.programa || '');
      if (c) set.set(c, prettyNivel(c));
    });
    const items = [...set.entries()].sort((a,b)=> a[1].localeCompare(b[1],'es'));
    sel.innerHTML = '<option value="">Todos los niveles</option>';
    for (const [canon,label] of items){
      const opt = document.createElement('option'); opt.value = canon; opt.textContent = label; sel.appendChild(opt);
    }
  }

  function fillGeneroFilter(list) {
  const sel = document.getElementById('filtroGenero');
  const set = new Set();
  list.forEach(x => {
    const genero = (x.genero || '').trim();
    if (genero) set.add(genero);
  });
  const items = Array.from(set).sort((a, b) => a.localeCompare(b, 'es'));
  sel.innerHTML = '<option value="">Todos los géneros</option>';
  items.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}


  // NUEVO: llenar opciones de “Última Vacante”
  function fillUltimaVacanteOptions(list){
    const sel = document.getElementById('filtroUltimaVacante');
    if (!sel) return;
    const set = new Set();
    list.forEach(r=>{
      const v = (r.ultimaVacante ?? '').toString().trim();
      if (v) set.add(v);
    });
    const items = Array.from(set).sort((a,b)=> a.localeCompare(b,'es'));
    sel.innerHTML = '<option value="">Todas</option>';
    items.forEach(v=>{
      const opt = document.createElement('option'); opt.value = v; opt.textContent = v; sel.appendChild(opt);
    });
  }

  function applyFilters(){
    const progCanonSel  = (document.getElementById('filtroPrograma').value||'');
    const generoSel = (document.getElementById('filtroGenero')?.value || '').toLowerCase();
    const nivelCanonSel = (document.getElementById('filtroNivel')?.value||'');
    const txt  = (document.getElementById('filtroTexto').value||'').toLowerCase();
    const ultSel = (document.getElementById('filtroUltimaVacante')?.value || '').toLowerCase();

    const filtered = coincidenciasExportables.filter(r=>{
      const pCanon = canonProgram(r.programa || '');
      const nCanon = nivelCanonRobusto(r.nivel || '', r.programa || '');
      const pIsTec = isProgramaTecnologia(r.programa || '');
      const okG = !generoSel || (r.genero || '').toLowerCase() === generoSel;
      const okP = !progCanonSel || pCanon === progCanonSel;

      let okN;
      if (!nivelCanonSel) okN = true;
      else if (nivelCanonSel === 'profesional') okN = (nCanon === 'profesional') && !pIsTec;
      else okN = (nCanon === nivelCanonSel);

      const okT = !txt || (r.nombre||'').toLowerCase().includes(txt) || (r.id||'').includes(txt) || (r.correo||'').toLowerCase().includes(txt) || (r.telefono||'').toLowerCase().includes(txt);

      const okUlt = !ultSel || (String(r.ultimaVacante ?? '').toLowerCase() === ultSel);

      return okP && okN && okT && okUlt && okG;

    });
    renderTabla(filtered);
  }
  document.getElementById('btnAplicarFiltro').addEventListener('click', applyFilters);
  document.getElementById('btnLimpiarFiltro').addEventListener('click', ()=>{
    document.getElementById('filtroPrograma').value='';
    document.getElementById('filtroTexto').value='';
    document.getElementById('filtroNivel').value='';
    const fuv=document.getElementById('filtroUltimaVacante'); if (fuv) fuv.value='';
    renderTabla(coincidenciasExportables);
  });

  // ===== Procesar =====
  document.getElementById('procesarBtn').addEventListener('click', async ()=>{
    const estado = document.getElementById('estado');
    const maestroFile = document.getElementById('fileMaestro').files[0];
    const esclavoFiles = selectedEsclavoFiles.slice();

    document.getElementById('tablaResultados').innerHTML=''; estado.textContent='';
    hasVacantesMeta = false;

    if (!maestroFile || esclavoFiles.length===0){ alert('Debes seleccionar ambos tipos de archivos'); return; }
    estado.textContent = '🔄 Procesando...';

    try{
      const maestroRows = await readWorkbookSmart(maestroFile);
      const maestroIdFallback = chooseIdByContent(maestroRows);
      const maestroCanon = maestroRows.map(r=>toCanonical(r, maestroIdFallback)).filter(Boolean);
      const mapM = new Map(maestroCanon.map(r=>[r.id, r]));

      let countPost=0, countCol=0;
      const coincidencias = [];

      for (const f of esclavoFiles){
        const rows = await readWorkbookSmart(f);
        const esclavoIdFallback = chooseIdByContent(rows);
        const esclavoCanon = rows.map(r=>toCanonical(r, esclavoIdFallback)).filter(Boolean);

        const matches = esclavoCanon
          .filter(r => mapM.has(r.id))
          .map(r => {
            const m = mapM.get(r.id);
            return {
              id: r.id,
              nombre:   r.nombre   || m.nombre   || '',
              programa: r.programa || m.programa || '',
              nivel:    r.nivel    || m.nivel    || '',
              genero:   r.genero   || m.genero   || '',
              hojaVida: r.hojaVida || m.hojaVida || '',
              telefono: r.telefono || m.telefono || '',
              correo:   r.correo   || m.correo   || '',
              codigoVacante: r.codigoVacante ?? '',
              ultimaVacante: r.ultimaVacante ?? ''
            };
          });

        coincidencias.push(...matches);

        const lname = f.name.toLowerCase();
        if (lname.includes('postulado')) countPost += matches.length;
        else if (lname.includes('colocado')) countCol += matches.length;

        if (lname.includes('oferentes') && lname.includes('postulado')) {
          hasVacantesMeta = true;
        }
      }

      // Quitar duplicados
      const seen = new Set();
      const uniques = [];
      for (const r of coincidencias) {
        const key = r.id + '|' + (r.programa||'') + '|' + (r.nivel||'');
        if (!seen.has(key)) { seen.add(key); uniques.push(r); }
      }
      coincidenciasExportables = uniques;

      fillProgramFilter(coincidenciasExportables);
      fillNivelFilter(coincidenciasExportables);
      fillGeneroFilter(coincidenciasExportables);
      renderTabla(coincidenciasExportables);

      // mostrar/ocultar y llenar opciones de Última Vacante
      const vacBox = document.getElementById('vacantesFilters');
      if (vacBox) vacBox.style.display = hasVacantesMeta ? 'block' : 'none';
      if (hasVacantesMeta) fillUltimaVacanteOptions(coincidenciasExportables);

      const c1 = document.getElementById('chartBusquedaColocacion').getContext('2d');
      if (chart1) chart1.destroy();
      chart1 = new Chart(c1, {
        type:'bar',
        data:{ labels:['Postulados','Colocados'], datasets:[{label:'Cantidad', data:[countPost,countCol], backgroundColor:['#007bfc','#28a745']} ] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });

      const c2 = document.getElementById('chartTasas').getContext('2d');
      if (chart2) chart2.destroy();
      const tasa = maestroCanon.length ? (coincidencias.length/maestroCanon.length)*100 : 0;
      chart2 = new Chart(c2, { type:'doughnut',
        data:{ labels:['Búsqueda','No búsqueda'], datasets:[{ data:[tasa,100-tasa], backgroundColor:['#ffc107','#e9ecef'] }] },
        options:{ responsive:true }
      });

      const ctxHv = document.getElementById('chartHojaVida').getContext('2d');
if (chartHv) chartHv.destroy();
const hvValues = coincidenciasExportables.map(r => {
  const v = parseFloat(r.hojaVida);
  return isNaN(v) ? 0 : v;
});
// Por ejemplo: agrupar en rangos 0‑20, 21‑40, 41‑60, 61‑80, 81‑100
const ranges = {
  '0‑20': 0, '21‑40': 0, '41‑60': 0, '61‑80': 0, '81‑100': 0
};
hvValues.forEach(v => {
  if (v <= 20) ranges['0‑20']++;
  else if (v <= 40) ranges['21‑40']++;
  else if (v <= 60) ranges['41‑60']++;
  else if (v <= 80) ranges['61‑80']++;
  else ranges['81‑100']++;
});
chartHv = new Chart(ctxHv, {
  type: 'bar',
  data: {
    labels: Object.keys(ranges),
    datasets: [{
      label: 'Número de personas',
      data: Object.values(ranges),
      backgroundColor: '#17a2b8'
    }]
  },
  options: {
    responsive: true,
    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
  }
});

const ctxP = document.getElementById('chartProgramaCount').getContext('2d');
if (chartProg) chartProg.destroy();

const countByProg = {};
coincidenciasExportables.forEach(r => {
  const canon = canonProgram(r.programa || '');
  const label = prettyProgram(canon, r.programa || '');
  countByProg[label] = (countByProg[label] || 0) + 1;
});

const labelsP = Object.keys(countByProg).sort((a, b) => a.localeCompare(b, 'es'));
const dataP = labelsP.map(lb => countByProg[lb]);

chartProg = new Chart(ctxP, {
  type: 'bar',
  data: {
    labels: labelsP,
    datasets: [{
      label: 'Personas',
      data: dataP,
      backgroundColor: labelsP.map((_, i) => `hsl(${(i * 47) % 360}, 70%, 60%)`)
    }]
  },
  options: {
  responsive: true,
  scales: {
    y: {
      beginAtZero: true,
      ticks: { precision: 0 }
    },
    x: {
      ticks: {
        maxRotation: 60,
        minRotation: 60,
        autoSkip: false
      }
    }
  }
}

});




      estado.textContent = '✅ Análisis completo';
    }catch(err){
      console.error(err);
      estado.textContent = '❌ Error durante el análisis';
    }
  });

  document.getElementById('limpiarBtn').addEventListener('click', ()=>{
    document.getElementById('fileMaestro').value='';
    document.getElementById('fileEsclavos').value='';
    document.getElementById('listMaestro').innerHTML='';
    document.getElementById('listEsclavos').innerHTML='';
    document.getElementById('tablaResultados').innerHTML='';
    document.getElementById('estado').textContent='';
    coincidenciasExportables=[];
    selectedEsclavoFiles = [];
    hasVacantesMeta = false;
    const vacBox = document.getElementById('vacantesFilters'); if (vacBox) vacBox.style.display='none';
    const fuv=document.getElementById('filtroUltimaVacante'); if (fuv) fuv.value='';
    if (chart1) chart1.destroy(); if (chart2) chart2.destroy();
    // NUEVO: reset contador
const cnt = document.getElementById('contadorPersonas');
if (cnt) cnt.textContent = 'Total: 0';
  });

  document.getElementById('exportarBtn').addEventListener('click', ()=>{
    if (!coincidenciasExportables.length){ alert('No hay coincidencias para exportar.'); return; }
    const datos = coincidenciasExportables.map(r=>({
      Documento:r.id, Nombre:r.nombre||'', 'Programa UTP':r.programa||'',
      'Último nivel educativo':prettyNivel(nivelCanonRobusto(r.nivel||'', r.programa||'')), Genero:r.genero||'', HojaVida:r.hojaVida||'',
      Celular:r.telefono||'', Correo:r.correo||''
    }));
    const ws = XLSX.utils.json_to_sheet(datos);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Coincidencias');
    XLSX.writeFile(wb, 'Coincidencias_Egresados.xlsx');
  });

  document.getElementById('exportarFil').addEventListener('click', () => {
  const progCanonSel = (document.getElementById('filtroPrograma').value || '');
  const nivelCanonSel = (document.getElementById('filtroNivel')?.value || '');
  const txt = (document.getElementById('filtroTexto').value || '').toLowerCase();
  const ultSel = (document.getElementById('filtroUltimaVacante')?.value || '').toLowerCase();

  const filtered = coincidenciasExportables.filter(r => {
    const pCanon = canonProgram(r.programa || '');
    const nCanon = nivelCanonRobusto(r.nivel || '', r.programa || '');
    const okP = !progCanonSel || pCanon === progCanonSel;

    let okN;
    if (!nivelCanonSel) okN = true;
    else if (nivelCanonSel === 'profesional') okN = (nCanon === 'profesional') && !isProgramaTecnologia(r.programa);
    else okN = (nCanon === nivelCanonSel);

    const okT = !txt || (r.nombre || '').toLowerCase().includes(txt) || (r.id || '').includes(txt) || (r.correo || '').toLowerCase().includes(txt) || (r.telefono || '').toLowerCase().includes(txt);
    const okUlt = !ultSel || (String(r.ultimaVacante ?? '').toLowerCase() === ultSel);

    return okP && okN && okT && okUlt;
  });

  if (!filtered.length) {
    alert('No hay registros para exportar con los filtros actuales.');
    return;
  }

  const datos = filtered.map(r => ({
    Documento: r.id,
    Nombre: r.nombre || '',
    'Programa utp': r.programa || '',
    'Último nivel educativo': prettyNivel(nivelCanonRobusto(r.nivel || '', r.programa || '')),
    Género: r.genero || '',
    'Hoja de Vida(%)': r.hojaVida || '',
    Celular: r.telefono || '',
    Correo: r.correo || ''
  }));

  const ws = XLSX.utils.json_to_sheet(datos);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Filtrados');
  XLSX.writeFile(wb, 'Coincidencias_Filtradas.xlsx');
});

  

  document.getElementById("btnLogout").addEventListener("click", () => {
    if (confirm("¿Estás seguro que deseas cerrar sesión?")) {
      loginOverlay.style.display = "flex";
      appContent.style.display = "none";
      document.getElementById("loginPassword").value = "";
    }
  });
</script>
</body>
</html>
